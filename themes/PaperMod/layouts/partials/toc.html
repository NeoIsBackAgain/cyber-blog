{{- $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content -}}
{{- $has_headers := ge (len $headers) 1 -}}
{{- if $has_headers -}}

<aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details {{if (.Param "TocOpen") }} open{{ end }}>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">{{- i18n "toc" | default "Table of Contents" }}</span>
            </summary>
            <div class="inner">
                {{- $largest := 6 -}}
                {{- range $headers -}}
                {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
                {{- $headerLevel := len (seq $headerLevel) -}}
                {{- if lt $headerLevel $largest -}}
                {{- $largest = $headerLevel -}}
                {{- end -}}
                {{- end -}}
                {{- $firstHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers 0) 1) 0)) -}}
                {{- $.Scratch.Set "bareul" slice -}}
                <ul>
                    {{- range seq (sub $firstHeaderLevel $largest) -}}
                    <ul>
                        {{- $.Scratch.Add "bareul" (sub (add $largest .) 1) -}}
                        {{- end -}}
                        {{- range $i, $header := $headers -}}
                        {{- $headerLevel := index (findRE "[1-6]" . 1) 0 -}}
                        {{- $headerLevel := len (seq $headerLevel) -}}
                        {{- $id := index (findRE "(id=\"(.*?)\")" $header 9) 0 }}
                        {{- $cleanedID := replace (replace $id "id=\"" "") "\"" "" }}
                        {{- $header := replaceRE "<h[1-6].*?>((.|\n])+?)</h[1-6]>" "$1" $header -}}
                        {{- if ne $i 0 -}}
                        {{- $prevHeaderLevel := index (findRE "[1-6]" (index $headers (sub $i 1)) 1) 0 -}}
                        {{- $prevHeaderLevel := len (seq $prevHeaderLevel) -}}
                        {{- if gt $headerLevel $prevHeaderLevel -}}
                        {{- range seq $prevHeaderLevel (sub $headerLevel 1) -}}
                        <ul>
                            {{- if ne $prevHeaderLevel . -}}
                            {{- $.Scratch.Add "bareul" . -}}
                            {{- end -}}
                            {{- end -}}
                            {{- else -}}
                            </li>
                            {{- if lt $headerLevel $prevHeaderLevel -}}
                            {{- range seq (sub $prevHeaderLevel 1) -1 $headerLevel -}}
                            {{- if in ($.Scratch.Get "bareul") . -}}
                        </ul>
                        {{- $tmp := $.Scratch.Get "bareul" -}}
                        {{- $.Scratch.Delete "bareul" -}}
                        {{- $.Scratch.Set "bareul" slice}}
                        {{- range seq (sub (len $tmp) 1) -}}
                        {{- $.Scratch.Add "bareul" (index $tmp (sub . 1)) -}}
                        {{- end -}}
                        {{- else -}}
                    </ul>
                    </li>
                    {{- end -}}
                    {{- end -}}
                    {{- end -}}
                    {{- end }}
                    <li>
                        <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                        {{- else }}
                    <li>
                        <a href="#{{- $cleanedID -}}" aria-label="{{- $header | plainify -}}">{{- $header | safeHTML -}}</a>
                        {{- end -}}
                        {{- end -}}
                        {{- $firstHeaderLevel := $largest }}
                        {{- $lastHeaderLevel := len (seq (index (findRE "[1-6]" (index $headers (sub (len $headers) 1)) 1) 0)) }}
                    </li>
                    {{- range seq (sub $lastHeaderLevel $firstHeaderLevel) -}}
                    {{- if in ($.Scratch.Get "bareul") (add . $firstHeaderLevel) }}
                </ul>
                {{- else }}
                </ul>
                </li>
                {{- end -}}
                {{- end }}
                </ul>
            </div>
        </details>
    </div>
</aside>

<script>
    (function() {
        let elements;
        
        function getOffsetTop(element) {
            if (!element.getClientRects().length) return 0;
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;   
        }

        function checkTocPosition() {
            const width = document.body.scrollWidth;
            if (width - 850 - (300 * 2) - 80 > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function updateAccordion() {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            let activeElement = null;

            // 1. Find the header currently in view
            // We scan all headers to find which one is closest to the top
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                // "window.innerHeight / 3" means we trigger the highlight 
                // when the header is in the top 30% of the screen
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2.5) {
                    activeElement = element;
                    break;
                }
            }

            // 2. Apply Classes
            if (activeElement) {
                // Decode ID to match href (handles %20 spaces etc)
                const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
                const activeLink = document.querySelector(`.inner ul li a[href="#${id}"]`);

                if (activeLink) {
                    // RESET: Close everything first
                    document.querySelectorAll('.toc li').forEach(li => li.classList.remove('active-parent'));
                    document.querySelectorAll('.toc a').forEach(a => a.classList.remove('active'));

                    // ACTIVATE: The specific link
                    activeLink.classList.add('active');

                    // EXPAND: Walk UP the tree to open all parents
                    let currentLi = activeLink.closest('li');
                    
                    while (currentLi) {
                        currentLi.classList.add('active-parent');
                        
                        // Try to find the next parent LI
                        const parentUl = currentLi.parentElement;
                        if (parentUl) {
                            // This finds the LI that contains the UL we are in
                            const grandParentLi = parentUl.closest('li');
                            if (grandParentLi) {
                                currentLi = grandParentLi;
                            } else {
                                // We reached the root
                                currentLi = null;
                            }
                        } else {
                            currentLi = null;
                        }
                    }
                }
            }
        }

        window.addEventListener('resize', checkTocPosition);
        
        window.addEventListener('DOMContentLoaded', () => {
            checkTocPosition();
            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            if(elements.length > 0) updateAccordion();
        });

        window.addEventListener('scroll', updateAccordion);
    })();
</script>
{{- end -}}