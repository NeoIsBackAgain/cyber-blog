<div class="home-dashboard">

    <div class="dash-search">
        <div class="search-input-wrapper">
            <span class="search-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </span>
            <input id="home-search-input" type="text" placeholder="Search boxes, tags, or cves..." autocomplete="off" />
        </div>
        <ul id="home-search-results" class="search-results-dropdown"></ul>
    </div>

    <style>
        .dash-search { width: 100%; max-width: 850px; margin: 0 auto 40px auto; position: relative; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .search-input-wrapper { background: #0f0f0f; border: 1px solid #333; border-radius: 12px; display: flex; align-items: center; padding: 12px 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); transition: all 0.2s ease; }
        .search-input-wrapper:focus-within { border-color: #1e90ff; box-shadow: 0 0 0 1px rgba(30, 144, 255, 0.5), 0 0 30px rgba(30, 144, 255, 0.1); }
        .search-icon { color: #555; margin-right: 15px; display: flex; }
        #home-search-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 1.1rem; outline: none; }
        #home-search-input::placeholder { color: #444; }
        
        .search-results-dropdown { display: none; position: absolute; top: 70px; left: 0; right: 0; background-color: #0f0f0f; border: 1px solid #333; border-radius: 12px; padding: 0; list-style: none; z-index: 99999 !important; box-shadow: 0 30px 80px rgba(0,0,0,0.9); max-height: 500px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 #0f0f0f; }
        .search-result-item { border-bottom: 1px solid #1a1a1a; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-link { display: flex; flex-direction: column; padding: 16px 22px; text-decoration: none; transition: background 0.1s ease; border-left: 3px solid transparent; }
        .search-result-link:hover { background: #141414; border-left-color: #1e90ff; }
        
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .result-title-group { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .result-icon svg { stroke: #444; transition: stroke 0.2s; }
        .search-result-link:hover .result-icon svg { stroke: #1e90ff; }
        .result-title { color: #eee; font-weight: 700; font-size: 1.05rem; letter-spacing: 0.3px; }
        .search-result-link:hover .result-title { color: #fff; }
        
        .tag-badge { background: rgba(255, 105, 180, 0.1); color: #FF69B4; font-family: 'Consolas', monospace; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 50px; border: 1px solid rgba(255, 105, 180, 0.25); white-space: nowrap; box-shadow: 0 0 10px rgba(255, 105, 180, 0.1); }
        .result-desc { color: #888; font-size: 0.9rem; line-height: 1.6; margin-left: 32px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>

<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var fuse; 
            var searchInput = document.getElementById('home-search-input');
            var resultsList = document.getElementById('home-search-results');

            function slugify(text) { return text.toString().toLowerCase().trim().replace(/&/g, '-and-').replace(/[\s\W-]+/g, '-').replace(/^-+|-+$/g, ''); }
            function stripHtml(html) { let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }

            // üß† NEW: Returns { text: "Display Text", anchor: "tag-slug" }
            function findBestMatch(item, term) {
                let sourceText = item.tips || item.content || "";
                let rawDescription = item.description || "";
                let rawSummary = stripHtml(item.summary || "");

                // 1. SEARCH: Keyword in Tag Tips (Content) -> Link to #Tag
                if (sourceText && term && sourceText.includes(":::")) {
                    let parts = sourceText.split("|||");
                    for (let part of parts) {
                        let separatorIndex = part.indexOf(":::");
                        if (separatorIndex !== -1) {
                            let currentTagName = part.substring(0, separatorIndex).trim();
                            let currentDesc = part.substring(separatorIndex + 3).trim();
                            
                            // Check if the keyword exists inside this specific tip
                            if (currentDesc.toLowerCase().includes(term.toLowerCase())) {
                                return {
                                    text: "üí° " + currentDesc, // Emoji for Tip Match
                                    anchor: slugify(currentTagName) // üîó Deep Link to this specific tag
                                };
                            }
                        }
                    }
                }

                // 2. SEARCH: Keyword in Frontmatter Description -> Link to Top
                if (rawDescription && term && rawDescription.toLowerCase().includes(term.toLowerCase())) {
                    return { text: "üìù " + rawDescription, anchor: "" };
                }

                // 3. FALLBACK: Generic Summary -> Link to Top
                let finalDesc = rawDescription || rawSummary || "";
                let clean = stripHtml(finalDesc).replace(/^Box Info\s*/i, '').replace(/^Pasted image\s.*/i, '');
                return { text: clean.substring(0, 180), anchor: "" };
            }

            // Standard Tag Match Helper
            function getTagTip(sourceText, targetTag) {
                if (targetTag && sourceText && sourceText.includes(":::")) {
                    let parts = sourceText.split("|||");
                    for (let part of parts) {
                        let separatorIndex = part.indexOf(":::");
                        if (separatorIndex !== -1) {
                            let tagName = part.substring(0, separatorIndex).trim();
                            let desc = part.substring(separatorIndex + 3).trim();
                            if (tagName.toLowerCase() === targetTag.toLowerCase()) return "üëâ " + desc;
                        }
                    }
                }
                return ""; // No tip found for this tag
            }

            fetch('{{ "index.json" | absURL }}?v=' + new Date().getTime())
                .then(res => res.ok ? res.text() : Promise.reject(res.status))
                .then(text => {
                    const start = text.indexOf('[');
                    const end = text.lastIndexOf(']') + 1;
                    if (start === -1 || end === -1) return [];
                    return JSON.parse(text.substring(start, end));
                })
                .then(data => {
                    var options = {
                        isCaseSensitive: false, shouldSort: true, minMatchCharLength: 2, threshold: 0.25, ignoreLocation: true,
                        keys: [ 
                            { name: "tags", weight: 3.0 }, 
                            { name: "tips", weight: 3.0 }, // Tips Content
                            { name: "description", weight: 3.0 }, // Description
                            { name: "title", weight: 2.0 }, 
                            { name: "content", weight: 0.5 }
                        ]
                    };
                    fuse = new Fuse(data, options);
                })
                .catch(err => console.error("‚ùå Search Error:", err));

            searchInput.addEventListener('input', function(e) { runSearch(this.value.trim()); });

            function runSearch(term) {
                if (!fuse || term.length < 2) { resultsList.style.display = 'none'; return; }

                var results = fuse.search(term);
                var resultsHTML = '';
                
                if (results.length > 0) {
                    results.forEach(function (value) {
                        let item = value.item;

                        // Filter: Exclude items with no tags or just 'blog'
                        if (!item.tags || item.tags.length === 0) return;
                        let validTags = item.tags.filter(t => t.toLowerCase() !== 'blog');
                        if (validTags.length === 0) return;

                        // Find matching tags (Priority 1)
                        let matchingTags = validTags.filter(t => t.toLowerCase().includes(term.toLowerCase()));

                        if (matchingTags.length > 0) {
                            // CASE A: User typed a Tag Name (e.g., "ftp")
                            matchingTags.forEach(tag => {
                                let tip = getTagTip(item.tips, tag);
                                // If no specific tip, use a generic description
                                if (!tip) tip = findBestMatch(item, "").text; 
                                
                                let url = item.permalink + "#" + slugify(tag);
                                resultsHTML += createListItem(url, item.title, tag, tip);
                            });
                        } else {
                            // CASE B: User typed a Keyword (e.g., "binary" or "backup")
                            // We use findBestMatch to get the text AND the correct anchor
                            let match = findBestMatch(item, term);
                            
                            let url = item.permalink;
                            if (match.anchor) {
                                url += "#" + match.anchor; // Append anchor if it's a Tip Match
                            }
                            
                            resultsHTML += createListItem(url, item.title, "", match.text);
                        }
                    });
                    resultsList.innerHTML = resultsHTML;
                    resultsList.style.display = 'block';
                } else {
                    resultsList.style.display = 'none';
                }
            }
            
            function createListItem(url, title, tag, desc) {
                let badgeHTML = tag ? `<div class="tag-badge">${tag}</div>` : '';
                return `
                <li class="search-result-item">
                    <a href="${url}" class="search-result-link">
                        <div class="result-header">
                            <div class="result-title-group">
                                <div class="result-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg></div>
                                <div class="result-title">${title}</div>
                            </div>
                            ${badgeHTML}
                        </div>
                        <div class="result-desc">${desc}</div>
                    </a>
                </li>`;
            }

            document.addEventListener('click', function(e) {
                if (!document.querySelector('.dash-search').contains(e.target)) { resultsList.style.display = 'none'; }
            });
        });
    </script>
    <div class="dash-grid">
        <a href="{{ "htb/" | absURL }}" class="dash-card htb">
            <div class="card-icon"><img src="{{ "images/htb.gif" | absURL }}" alt="HTB" class="dash-icon-img"></div>
            <h3>HTB Collection</h3><span>HackTheBox Writeups</span>
        </a>
        <a href="{{ "offsec/" | absURL }}" class="dash-card offsec">
            <div class="card-icon"><img src="{{ "images/offsec.png" | absURL }}" alt="Offsec" class="dash-icon-img"></div>
            <h3>OffSec</h3><span>Exam & Labs</span>
        </a>
        <a href="{{ "bug-research/" | absURL }}" class="dash-card bug">
            <div class="card-icon"><img src="{{ "images/BugBounty.png" | absURL }}" alt="Bug" class="dash-icon-img"></div>
            <h3>Bug Research</h3><span>CVEs & Findings</span>
        </a>
        <a href="{{ "misc/" | absURL }}" class="dash-card misc">
            <div class="card-icon"><img src="{{ "images/misc.png" | absURL }}" alt="Misc" class="dash-icon-img"></div>
            <h3>Misc / ÈõúÈ†Ö</h3><span>Tools & Random</span>
        </a>
        <a href="{{ "tags/" | absURL }}" class="dash-card tags">
            <div class="card-icon"><img src="{{ "images/tags.png" | absURL }}" alt="Tags" class="dash-icon-img"></div>
            <h3>All Tags</h3><span>Browse by Category</span>
        </a>
    </div>

    <div class="dash-recent">
        <h2>üî• Recent Activity</h2>
        <div class="recent-list">
            {{ $pages := where .Site.RegularPages "Type" "in" site.Params.mainSections }}
            {{ range first 5 $pages }}
            <div class="recent-item">
                <span class="date">{{ .Date.Format "Jan 02" }}</span>
                <a href="{{ .Permalink }}" class="title">{{ .Title }}</a>
                <span class="read-time">{{ .ReadingTime }} min read</span>
            </div>
            {{ end }}
        </div>
        <div class="more-btn-container">
            <a href="{{ "posts/" | absURL }}" class="btn-more">View Archive ‚Üí</a>
        </div>
    </div>
</div>